<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>成型条件记录管理系统</title>
    <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/menuStyle.css">
    <link rel="import" href="import.html" id="page2"/>


</head>

<body class="nav-md">

<div class="container body">
    <div class="main_container">

        <div class="col-md-3 left_col">
            <div class="left_col scroll-view">
                <div class="navbar nav_title" style="border: 0;">
                    <a href="index.html" class="site_title"><i class="fa fa-paw"></i> <span>成型条件管理</span></a>
                </div>

                <div class="clearfix"></div>

                <!-- menu profile quick info -->
                <div class="profile clearfix">
                    <div class="profile_pic">
                        <img src="images/timg.jpeg" alt="..." class="img-circle profile_img">
                    </div>
                    <div class="profile_info">
                        <span>欢迎</span>
                        <h2 class="login_user"></h2>
                    </div>
                </div>
                <!-- /menu profile quick info -->

                <br />

                <!-- sidebar menu -->
                <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
                    <div class="menu_section">
                        <ul class="nav side-menu">

                            <li style="display: none;" id="commonLi"><a><i class="fa fa-edit"></i> 成型条件 <span class="fa fa-chevron-down"></span></a>
                                <ul class="nav child_menu">
                                    <li><a href="form.html">记录管理</a></li>
                                </ul>
                            </li>
                            <!--display: block;-->
                            <li style="display: none;" id="adminLi"><a><i class="fa fa-clone"></i> admin <span class="fa fa-chevron-down"></span></a>
                                <ul class="nav child_menu">
                                    <li><a href="user.html">用户管理</a></li>
                                    <li><a href="menu.html">菜单管理</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>

                </div>
                <!-- /sidebar menu -->

                <!-- /menu footer buttons -->
                <div class="sidebar-footer hidden-small">
                    <a data-toggle="tooltip" data-placement="top" title="退出" onclick="logoff()" href="login.html">
                        <span class="glyphicon glyphicon-off" aria-hidden="true"></span>
                    </a>
                </div>
                <!-- /menu footer buttons -->
            </div>
        </div>

        <!-- top navigation -->
        <div class="top_nav">
            <div class="nav_menu">
                <nav>
                    <div class="nav toggle">
                        <a id="menu_toggle"><i class="fa fa-bars"></i></a>
                    </div>

                    <ul class="nav navbar-nav navbar-right">
                        <li class="">
                            <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                <img src="images/timg.jpeg" alt=""><span class="login_user"></span>
                                <span class=" fa fa-angle-down"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-usermenu pull-right">
                                <li><a href="login.html" onclick="logoff()"><i class="fa fa-sign-out pull-right"></i> 退出</a></li>
                            </ul>
                        </li>

                    </ul>
                </nav>
            </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
            <div class="">
                <div class="page-title">
                    <div class="title_left">
                        <h3>菜单管理 <small>非管理员用户不能操作</small></h3>
                    </div>
                </div>
                <div class="clearfix"></div>


                <button  class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">新增菜单</button>
                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                    &times;
                                </button>
                                <h4 class="modal-title" id="myModalLabel">
                                    操作菜单
                                </h4>
                            </div>
                            <div class="modal-body">
                                菜单名称: <input type="text" name="menuName" id="menuName"/>
                                         <input type="hidden" name="parentID" id="parentID">
                                         <input type="hidden" name="menuLevel" id="menuLevel" value="1">
                                         <input type="hidden" name="menuID" id="menuID">
                                         <input type="hidden" name="actionType" id="actionType">

                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                                </button>
                                <button type="button" class="btn btn-primary" onclick="editMenu()">
                                    提交
                                </button>
                            </div>
                        </div><!-- /.modal-content -->
                    </div><!-- /.modal -->
                </div>



                <div class="htmleaf-container">
                    <ul class="menu">
                        <!--<li class="list top first">
                            <a href="javascript: void(0);"> 一级菜单1 </a>
                            <a href="javascript:void(0);" class="addType">操作</a>
                            <ul class="items">
                                <li class="second">
                                    <a href="javascript: void(0);"> 二级菜单1</a>
                                    <a href="javascript:void(0);" class="addType">操作</a>
                                </li>
                                <li class="list second">
                                    <a href="javascript: void(0);"> 二级菜单2</a>
                                    <a href="javascript:void(0);" class="addType">操作</a>
                                    <ul class="items">
                                        <li class="third">
                                            <a href="javascript: void(0);"> 三级菜单1</a>
                                            <a href="javascript:void(0);" class="addType">操作</a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>-->
                    </ul>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
        <!-- /page content -->

        <!-- footer content -->

        <!-- /footer content -->
    </div>
</div>

<script type="text/javascript">
    function loadMenu(data) {
        var menuList = data.data
        var innerHtml = ""
        for ( var i = 0; i <menuList.length; i++){
            //判断一级菜单是否有子菜单 来决定要不要加list class
            innerHtml += "<li class=\"list top first\" >";

            var isActive = menuList[i].action == 1?"   (启用中)":"   (禁用中)"
            var oneData = menuList[i].menuID + "_" + menuList[i].menuLevel + "_" + menuList[i].action + "_" + menuList[i].parentID
            innerHtml += "<a href=\"javascript: void(0);\"  dataMenuInfo="+ oneData +">" + menuList[i].menuName + isActive +"</a>"
            innerHtml += "<a href=\"javascript:void(0);\" class=\"addType\" dataMenuInfo=" + oneData + ">操作  </a>";
            //有二级菜单的情况
            if(menuList[i].childList != null && menuList[i].childList.length > 0) {
                innerHtml += "<ul class=\"items\">"
                for( var j = 0; j <menuList[i].childList.length; j++) {
                    //判断二级菜单是否有子菜单 来决定要不要加list class
                    var twoMenu = menuList[i].childList[j]
                    innerHtml += "<li class=\"list second\" >"

                    var isActiveTwo = twoMenu.action == 1?"   (启用中)":"   (禁用中)"
                    var twoData = twoMenu.menuID + "_" + twoMenu.menuLevel + "_" + twoMenu.action + "_" + twoMenu.parentID
                    innerHtml += "<a href=\"javascript: void(0);\" dataMenuInfo="+ twoData +">" + twoMenu.menuName + isActiveTwo + "</a>"
                    innerHtml += "<a href=\"javascript:void(0);\" class=\"addType\" dataMenuInfo=" + twoData + ">操作  </a>"
                    if(twoMenu.childList != null && twoMenu.childList.length > 0) {
                        innerHtml += "<ul class=\"items\">"
                        //铺三级菜单
                        for(var p = 0; p <twoMenu.childList.length; p++) {
                            var threeMenu = twoMenu.childList[p]
                            var isActiveThree = threeMenu.action == 1?"   (启用中)":"   (禁用中)"
                            var threeData = threeMenu.menuID + "_" + threeMenu.menuLevel + "_" + threeMenu.action + "_" + threeMenu.parentID
                            innerHtml += "<li class=\"third\">"
                            innerHtml += "<a href=\"javascript: void(0);\" dataMenuInfo="+ threeData +">" +threeMenu.menuName + isActiveThree + "</a>"
                            innerHtml += "<a href=\"javascript:void(0);\" class=\"addType\" dataMenuInfo=" +threeData+">操作  </a>"
                            innerHtml += "</li>"
                        }
                        innerHtml += "</ul>"
                    }
                    innerHtml += "</li>"
                }
                innerHtml += "</ul>"
            }
            innerHtml += "</li>";
        }
        document.getElementsByClassName("menu")[0].innerHTML = innerHtml
        var list = document.querySelectorAll('.list');
        var addType = document.querySelectorAll('.addType');

        for (i = 0; i < addType.length; i++) {
            addType[i].addEventListener('click', addTypeAction);
        }
        for (i = 0; i < list.length; i++) {
            list[i].addEventListener('click', accordion);
        }
    }

    function addTypeAction(e){
        var parentEl = $(e.target.parentNode)
        var value = e.currentTarget.attributes.dataMenuInfo.value
        var data = value.split("_")
        if (parentEl.find('.actionContent').length !== 0) {
            parentEl.find('.actionContent').remove();
        } else {
            var ele = '<div class="actionContent">'
            if(data[1]!= 3) {
                ele += '<span class="addMenu" dataMenuInfo=' +value+ '>新增</span>'
            }
            ele +=  '<span class="updateMenu" dataMenuInfo=' +value+ '>修改</span>'
            if(data[2] ==1) {
                ele += '<span class="isActiveMenu" dataMenuInfo=' +value+ '>禁用</span>'
            }else {
                ele += '<span class="isActiveMenu" dataMenuInfo=' +value+ '>启用</span>'
            }
            ele +=  '<span class="deleteMenu" dataMenuInfo=' +value+ '>删除</span>'
            ele += '</div>'

            parentEl.prepend(ele)
        }
        e.stopPropagation();
    }
    function accordion(e) {
        var parentEl = $(e.target.parentNode)
        if ($('.actionContent').length !== 0 && !$(e.target).hasClass('addMenu') && !$(e.target).hasClass('deleteMenu')) {
            $('.actionContent').remove();
        }
        if (!parentEl.hasClass('active') && $(parentEl).find('.items').length) {
            parentEl.addClass('active')
        } else if (parentEl.hasClass('active')) {
            parentEl.removeClass('active')
        }
        if ($(e.target).hasClass('addMenu')) {
            var data = $(e.target).attr("dataMenuInfo").split("_")
            document.getElementById("parentID").value = data[0]
            document.getElementById("menuLevel").value = (parseInt(data[1]) +1)
            $('#myModal').modal('show')

        }
        if ($(e.target).hasClass('updateMenu')) {
            var data = $(e.target).attr("dataMenuInfo").split("_")
            document.getElementById("menuID").value = data[0]
            document.getElementById("actionType").value = 1
            $('#myModal').modal('show')

        }
        if ($(e.target).hasClass('isActiveMenu')) {
            var data = $(e.target).attr("dataMenuInfo").split("_")
            var action = data[2] == 1? 2:1
            var request = {"menuID":data[0],action:action,"parentID":data[3]}
            sendRequest("/menu/activeMenu",request);
            clear()
            window.location.reload()
        }
        if ($(e.target).hasClass('deleteMenu')) {
            var data = $(e.target).attr("dataMenuInfo").split("_")
            var request = {"menuID":data[0]}
            sendRequest("/menu/deleteMenu",request);
            clear()
            window.location.reload()
        }


        if ($(e.target).hasClass('deleteMenu') && !$(e.target).closest('li').hasClass('top')) {
            $(e.target).closest('li').remove()
        }
        e.stopPropagation();
    }

    function clear() {
        document.getElementById("menuName").value = ""
        document.getElementById("menuID").value = ""
        document.getElementById("parentID").value = ""
        document.getElementById("menuLevel").value = ""
        document.getElementById("actionType").value = ""
    }

    function editMenu() {
        var menuName = document.getElementById("menuName")
        var menuID = document.getElementById("menuID")
        var parentID = document.getElementById("parentID")
        var menuLevel = document.getElementById("menuLevel")
        var actionType = document.getElementById("actionType")
        var data = {"menuName":menuName.value,"menuLevel":menuLevel.value,"menuID":menuID.value,"parentID":parentID.value}
        var method = actionType.value == 1 ? "/menu/updateMenu":"/menu/addMenu"
        sendRequest(method,data,function (data) {
            $('#myModal').modal('hide')
        })
        clear()
        window.location.reload()
    }

    $(document).ready(function () {
        sendRequest("/menu/queryMenu",{},loadMenu);
        $('html').click(function(){
            if ($('.actionContent').length !== 0) {
                $('.actionContent').remove();
            }
        })

    })

</script>

</body>
</html>